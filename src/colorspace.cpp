//
// Copyright (C) Wojciech Jarosz. All rights reserved.
// Use of this source code is governed by a BSD-style license that can
// be found in the LICENSE.txt file.
//

#include "colorspace.h"
#include <cmath>
#include <float.h>

#define SMALL_THREADPOOL_IMPLEMENTATION
#include "smallthreadpool.h"

using namespace std;
using namespace stp;

// source: https://cie.co.at/data-tables

static const TabulatedSpectrum<float3> s_CIE_D_bases = {
    {{0.04f, 0.02f, 0.00f},     {3.02f, 2.26f, 1.00f},     {6.00f, 4.50f, 2.00f},     {17.80f, 13.45f, 3.00f},
     {29.60f, 22.40f, 4.00f},   {42.45f, 32.20f, 6.25f},   {55.30f, 42.00f, 8.50f},   {56.30f, 41.30f, 8.15f},
     {57.30f, 40.60f, 7.80f},   {59.55f, 41.10f, 7.25f},   {61.80f, 41.60f, 6.70f},   {61.65f, 39.80f, 6.00f},
     {61.50f, 38.00f, 5.30f},   {65.15f, 40.20f, 5.70f},   {68.80f, 42.40f, 6.10f},   {66.10f, 40.45f, 4.55f},
     {63.40f, 38.50f, 3.00f},   {64.60f, 36.75f, 2.10f},   {65.80f, 35.00f, 1.20f},   {80.30f, 39.20f, 0.05f},
     {94.80f, 43.40f, -1.10f},  {99.80f, 44.85f, -0.80f},  {104.80f, 46.30f, -0.50f}, {105.35f, 45.10f, -0.60f},
     {105.90f, 43.90f, -0.70f}, {101.35f, 40.50f, -0.95f}, {96.80f, 37.10f, -1.20f},  {105.35f, 36.90f, -1.90f},
     {113.90f, 36.70f, -2.60f}, {119.75f, 36.30f, -2.75f}, {125.60f, 35.90f, -2.90f}, {125.55f, 34.25f, -2.85f},
     {125.50f, 32.60f, -2.80f}, {123.40f, 30.25f, -2.70f}, {121.30f, 27.90f, -2.60f}, {121.30f, 26.10f, -2.60f},
     {121.30f, 24.30f, -2.60f}, {117.40f, 22.20f, -2.20f}, {113.50f, 20.10f, -1.80f}, {113.30f, 18.15f, -1.65f},
     {113.10f, 16.20f, -1.50f}, {111.95f, 14.70f, -1.40f}, {110.80f, 13.20f, -1.30f}, {108.65f, 10.90f, -1.25f},
     {106.50f, 8.60f, -1.20f},  {107.65f, 7.35f, -1.10f},  {108.80f, 6.10f, -1.00f},  {107.05f, 5.15f, -0.75f},
     {105.30f, 4.20f, -0.50f},  {104.85f, 3.05f, -0.40f},  {104.40f, 1.90f, -0.30f},  {102.20f, 0.95f, -0.15f},
     {100.00f, 0.00f, 0.00f},   {98.00f, -0.80f, 0.10f},   {96.00f, -1.60f, 0.20f},   {95.55f, -2.55f, 0.35f},
     {95.10f, -3.50f, 0.50f},   {92.10f, -3.50f, 1.30f},   {89.10f, -3.50f, 2.10f},   {89.80f, -4.65f, 2.65f},
     {90.50f, -5.80f, 3.20f},   {90.40f, -6.50f, 3.65f},   {90.30f, -7.20f, 4.10f},   {89.35f, -7.90f, 4.40f},
     {88.40f, -8.60f, 4.70f},   {86.20f, -9.05f, 4.90f},   {84.00f, -9.50f, 5.10f},   {84.55f, -10.20f, 5.90f},
     {85.10f, -10.90f, 6.70f},  {83.50f, -10.80f, 7.00f},  {81.90f, -10.70f, 7.30f},  {82.25f, -11.35f, 7.95f},
     {82.60f, -12.00f, 8.60f},  {83.75f, -13.00f, 9.20f},  {84.90f, -14.00f, 9.80f},  {83.10f, -13.80f, 10.00f},
     {81.30f, -13.60f, 10.20f}, {76.60f, -12.80f, 9.25f},  {71.90f, -12.00f, 8.30f},  {73.10f, -12.65f, 8.95f},
     {74.30f, -13.30f, 9.60f},  {75.35f, -13.10f, 9.05f},  {76.40f, -12.90f, 8.50f},  {69.85f, -11.75f, 7.75f},
     {63.30f, -10.60f, 7.00f},  {67.50f, -11.10f, 7.30f},  {71.70f, -11.60f, 7.60f},  {74.35f, -11.90f, 7.80f},
     {77.00f, -12.20f, 8.00f},  {71.10f, -11.20f, 7.35f},  {65.20f, -10.20f, 6.70f},  {56.45f, -9.00f, 5.95f},
     {47.70f, -7.80f, 5.20f},   {58.15f, -9.50f, 6.30f},   {68.60f, -11.20f, 7.40f},  {66.80f, -10.80f, 7.10f},
     {65.00f, -10.40f, 6.80f},  {65.50f, -10.50f, 6.90f},  {66.00f, -10.60f, 7.00f},  {63.50f, -10.15f, 6.70f},
     {61.00f, -9.70f, 6.40f},   {57.15f, -9.00f, 5.95f},   {53.30f, -8.30f, 5.50f},   {56.10f, -8.80f, 5.80f},
     {58.90f, -9.30f, 6.10f},   {60.40f, -9.55f, 6.30f},   {61.90f, -9.80f, 6.50f}},
    300.f,
    830.f};

static const TabulatedSpectrum<float3> s_CIE_xyz = {
    {{0.000129900000f, 0.0000039170000f, 0.000606100000f}, {0.000145847000f, 0.0000043935810f, 0.000680879200f},
     {0.000163802100f, 0.0000049296040f, 0.000765145600f}, {0.000184003700f, 0.0000055321360f, 0.000860012400f},
     {0.000206690200f, 0.0000062082450f, 0.000966592800f}, {0.000232100000f, 0.0000069650000f, 0.001086000000f},
     {0.000260728000f, 0.0000078132190f, 0.001220586000f}, {0.000293075000f, 0.0000087673360f, 0.001372729000f},
     {0.000329388000f, 0.0000098398440f, 0.001543579000f}, {0.000369914000f, 0.0000110432300f, 0.001734286000f},
     {0.000414900000f, 0.0000123900000f, 0.001946000000f}, {0.000464158700f, 0.0000138864100f, 0.002177777000f},
     {0.000518986000f, 0.0000155572800f, 0.002435809000f}, {0.000581854000f, 0.0000174429600f, 0.002731953000f},
     {0.000655234700f, 0.0000195837500f, 0.003078064000f}, {0.000741600000f, 0.0000220200000f, 0.003486000000f},
     {0.000845029600f, 0.0000248396500f, 0.003975227000f}, {0.000964526800f, 0.0000280412600f, 0.004540880000f},
     {0.001094949000f, 0.0000315310400f, 0.005158320000f}, {0.001231154000f, 0.0000352152100f, 0.005802907000f},
     {0.001368000000f, 0.0000390000000f, 0.006450001000f}, {0.001502050000f, 0.0000428264000f, 0.007083216000f},
     {0.001642328000f, 0.0000469146000f, 0.007745488000f}, {0.001802382000f, 0.0000515896000f, 0.008501152000f},
     {0.001995757000f, 0.0000571764000f, 0.009414544000f}, {0.002236000000f, 0.0000640000000f, 0.010549990000f},
     {0.002535385000f, 0.0000723442100f, 0.011965800000f}, {0.002892603000f, 0.0000822122400f, 0.013655870000f},
     {0.003300829000f, 0.0000935081600f, 0.015588050000f}, {0.003753236000f, 0.0001061361000f, 0.017730150000f},
     {0.004243000000f, 0.0001200000000f, 0.020050010000f}, {0.004762389000f, 0.0001349840000f, 0.022511360000f},
     {0.005330048000f, 0.0001514920000f, 0.025202880000f}, {0.005978712000f, 0.0001702080000f, 0.028279720000f},
     {0.006741117000f, 0.0001918160000f, 0.031897040000f}, {0.007650000000f, 0.0002170000000f, 0.036210000000f},
     {0.008751373000f, 0.0002469067000f, 0.041437710000f}, {0.010028880000f, 0.0002812400000f, 0.047503720000f},
     {0.011421700000f, 0.0003185200000f, 0.054119880000f}, {0.012869010000f, 0.0003572667000f, 0.060998030000f},
     {0.014310000000f, 0.0003960000000f, 0.067850010000f}, {0.015704430000f, 0.0004337147000f, 0.074486320000f},
     {0.017147440000f, 0.0004730240000f, 0.081361560000f}, {0.018781220000f, 0.0005178760000f, 0.089153640000f},
     {0.020748010000f, 0.0005722187000f, 0.098540480000f}, {0.023190000000f, 0.0006400000000f, 0.110200000000f},
     {0.026207360000f, 0.0007245600000f, 0.124613300000f}, {0.029782480000f, 0.0008255000000f, 0.141701700000f},
     {0.033880920000f, 0.0009411600000f, 0.161303500000f}, {0.038468240000f, 0.0010698800000f, 0.183256800000f},
     {0.043510000000f, 0.0012100000000f, 0.207400000000f}, {0.048995600000f, 0.0013620910000f, 0.233692100000f},
     {0.055022600000f, 0.0015307520000f, 0.262611400000f}, {0.061718800000f, 0.0017203680000f, 0.294774600000f},
     {0.069212000000f, 0.0019353230000f, 0.330798500000f}, {0.077630000000f, 0.0021800000000f, 0.371300000000f},
     {0.086958110000f, 0.0024548000000f, 0.416209100000f}, {0.097176720000f, 0.0027640000000f, 0.465464200000f},
     {0.108406300000f, 0.0031178000000f, 0.519694800000f}, {0.120767200000f, 0.0035264000000f, 0.579530300000f},
     {0.134380000000f, 0.0040000000000f, 0.645600000000f}, {0.149358200000f, 0.0045462400000f, 0.718483800000f},
     {0.165395700000f, 0.0051593200000f, 0.796713300000f}, {0.181983100000f, 0.0058292800000f, 0.877845900000f},
     {0.198611000000f, 0.0065461600000f, 0.959439000000f}, {0.214770000000f, 0.0073000000000f, 1.039050100000f},
     {0.230186800000f, 0.0080865070000f, 1.115367300000f}, {0.244879700000f, 0.0089087200000f, 1.188497100000f},
     {0.258777300000f, 0.0097676800000f, 1.258123300000f}, {0.271807900000f, 0.0106644300000f, 1.323929600000f},
     {0.283900000000f, 0.0116000000000f, 1.385600000000f}, {0.294943800000f, 0.0125731700000f, 1.442635200000f},
     {0.304896500000f, 0.0135827200000f, 1.494803500000f}, {0.313787300000f, 0.0146296800000f, 1.542190300000f},
     {0.321645400000f, 0.0157150900000f, 1.584880700000f}, {0.328500000000f, 0.0168400000000f, 1.622960000000f},
     {0.334351300000f, 0.0180073600000f, 1.656404800000f}, {0.339210100000f, 0.0192144800000f, 1.685295900000f},
     {0.343121300000f, 0.0204539200000f, 1.709874500000f}, {0.346129600000f, 0.0217182400000f, 1.730382100000f},
     {0.348280000000f, 0.0230000000000f, 1.747060000000f}, {0.349599900000f, 0.0242946100000f, 1.760044600000f},
     {0.350147400000f, 0.0256102400000f, 1.769623300000f}, {0.350013000000f, 0.0269585700000f, 1.776263700000f},
     {0.349287000000f, 0.0283512500000f, 1.780433400000f}, {0.348060000000f, 0.0298000000000f, 1.782600000000f},
     {0.346373300000f, 0.0313108300000f, 1.782968200000f}, {0.344262400000f, 0.0328836800000f, 1.781699800000f},
     {0.341808800000f, 0.0345211200000f, 1.779198200000f}, {0.339094100000f, 0.0362257100000f, 1.775867100000f},
     {0.336200000000f, 0.0380000000000f, 1.772110000000f}, {0.333197700000f, 0.0398466700000f, 1.768258900000f},
     {0.330041100000f, 0.0417680000000f, 1.764039000000f}, {0.326635700000f, 0.0437660000000f, 1.758943800000f},
     {0.322886800000f, 0.0458426700000f, 1.752466300000f}, {0.318700000000f, 0.0480000000000f, 1.744100000000f},
     {0.314025100000f, 0.0502436800000f, 1.733559500000f}, {0.308884000000f, 0.0525730400000f, 1.720858100000f},
     {0.303290400000f, 0.0549805600000f, 1.705936900000f}, {0.297257900000f, 0.0574587200000f, 1.688737200000f},
     {0.290800000000f, 0.0600000000000f, 1.669200000000f}, {0.283970100000f, 0.0626019700000f, 1.647528700000f},
     {0.276721400000f, 0.0652775200000f, 1.623412700000f}, {0.268917800000f, 0.0680420800000f, 1.596022300000f},
     {0.260422700000f, 0.0709110900000f, 1.564528000000f}, {0.251100000000f, 0.0739000000000f, 1.528100000000f},
     {0.240847500000f, 0.0770160000000f, 1.486111400000f}, {0.229851200000f, 0.0802664000000f, 1.439521500000f},
     {0.218407200000f, 0.0836668000000f, 1.389879900000f}, {0.206811500000f, 0.0872328000000f, 1.338736200000f},
     {0.195360000000f, 0.0909800000000f, 1.287640000000f}, {0.184213600000f, 0.0949175500000f, 1.237422300000f},
     {0.173327300000f, 0.0990458400000f, 1.187824300000f}, {0.162688100000f, 0.1033674000000f, 1.138761100000f},
     {0.152283300000f, 0.1078846000000f, 1.090148000000f}, {0.142100000000f, 0.1126000000000f, 1.041900000000f},
     {0.132178600000f, 0.1175320000000f, 0.994197600000f}, {0.122569600000f, 0.1226744000000f, 0.947347300000f},
     {0.113275200000f, 0.1279928000000f, 0.901453100000f}, {0.104297900000f, 0.1334528000000f, 0.856619300000f},
     {0.095640000000f, 0.1390200000000f, 0.812950100000f}, {0.087299550000f, 0.1446764000000f, 0.770517300000f},
     {0.079308040000f, 0.1504693000000f, 0.729444800000f}, {0.071717760000f, 0.1564619000000f, 0.689913600000f},
     {0.064580990000f, 0.1627177000000f, 0.652104900000f}, {0.057950010000f, 0.1693000000000f, 0.616200000000f},
     {0.051862110000f, 0.1762431000000f, 0.582328600000f}, {0.046281520000f, 0.1835581000000f, 0.550416200000f},
     {0.041150880000f, 0.1912735000000f, 0.520337600000f}, {0.036412830000f, 0.1994180000000f, 0.491967300000f},
     {0.032010000000f, 0.2080200000000f, 0.465180000000f}, {0.027917200000f, 0.2171199000000f, 0.439924600000f},
     {0.024144400000f, 0.2267345000000f, 0.416183600000f}, {0.020687000000f, 0.2368571000000f, 0.393882200000f},
     {0.017540400000f, 0.2474812000000f, 0.372945900000f}, {0.014700000000f, 0.2586000000000f, 0.353300000000f},
     {0.012161790000f, 0.2701849000000f, 0.334857800000f}, {0.009919960000f, 0.2822939000000f, 0.317552100000f},
     {0.007967240000f, 0.2950505000000f, 0.301337500000f}, {0.006296346000f, 0.3085780000000f, 0.286168600000f},
     {0.004900000000f, 0.3230000000000f, 0.272000000000f}, {0.003777173000f, 0.3384021000000f, 0.258817100000f},
     {0.002945320000f, 0.3546858000000f, 0.246483800000f}, {0.002424880000f, 0.3716986000000f, 0.234771800000f},
     {0.002236293000f, 0.3892875000000f, 0.223453300000f}, {0.002400000000f, 0.4073000000000f, 0.212300000000f},
     {0.002925520000f, 0.4256299000000f, 0.201169200000f}, {0.003836560000f, 0.4443096000000f, 0.190119600000f},
     {0.005174840000f, 0.4633944000000f, 0.179225400000f}, {0.006982080000f, 0.4829395000000f, 0.168560800000f},
     {0.009300000000f, 0.5030000000000f, 0.158200000000f}, {0.012149490000f, 0.5235693000000f, 0.148138300000f},
     {0.015535880000f, 0.5445120000000f, 0.138375800000f}, {0.019477520000f, 0.5656900000000f, 0.128994200000f},
     {0.023992770000f, 0.5869653000000f, 0.120075100000f}, {0.029100000000f, 0.6082000000000f, 0.111700000000f},
     {0.034814850000f, 0.6293456000000f, 0.103904800000f}, {0.041120160000f, 0.6503068000000f, 0.096667480000f},
     {0.047985040000f, 0.6708752000000f, 0.089982720000f}, {0.055378610000f, 0.6908424000000f, 0.083845310000f},
     {0.063270000000f, 0.7100000000000f, 0.078249990000f}, {0.071635010000f, 0.7281852000000f, 0.073208990000f},
     {0.080462240000f, 0.7454636000000f, 0.068678160000f}, {0.089739960000f, 0.7619694000000f, 0.064567840000f},
     {0.099456450000f, 0.7778368000000f, 0.060788350000f}, {0.109600000000f, 0.7932000000000f, 0.057250010000f},
     {0.120167400000f, 0.8081104000000f, 0.053904350000f}, {0.131114500000f, 0.8224962000000f, 0.050746640000f},
     {0.142367900000f, 0.8363068000000f, 0.047752760000f}, {0.153854200000f, 0.8494916000000f, 0.044898590000f},
     {0.165500000000f, 0.8620000000000f, 0.042160000000f}, {0.177257100000f, 0.8738108000000f, 0.039507280000f},
     {0.189140000000f, 0.8849624000000f, 0.036935640000f}, {0.201169400000f, 0.8954936000000f, 0.034458360000f},
     {0.213365800000f, 0.9054432000000f, 0.032088720000f}, {0.225749900000f, 0.9148501000000f, 0.029840000000f},
     {0.238320900000f, 0.9237348000000f, 0.027711810000f}, {0.251066800000f, 0.9320924000000f, 0.025694440000f},
     {0.263992200000f, 0.9399226000000f, 0.023787160000f}, {0.277101700000f, 0.9472252000000f, 0.021989250000f},
     {0.290400000000f, 0.9540000000000f, 0.020300000000f}, {0.303891200000f, 0.9602561000000f, 0.018718050000f},
     {0.317572600000f, 0.9660074000000f, 0.017240360000f}, {0.331438400000f, 0.9712606000000f, 0.015863640000f},
     {0.345482800000f, 0.9760225000000f, 0.014584610000f}, {0.359700000000f, 0.9803000000000f, 0.013400000000f},
     {0.374083900000f, 0.9840924000000f, 0.012307230000f}, {0.388639600000f, 0.9874182000000f, 0.011301880000f},
     {0.403378400000f, 0.9903128000000f, 0.010377920000f}, {0.418311500000f, 0.9928116000000f, 0.009529306000f},
     {0.433449900000f, 0.9949501000000f, 0.008749999000f}, {0.448795300000f, 0.9967108000000f, 0.008035200000f},
     {0.464336000000f, 0.9980983000000f, 0.007381600000f}, {0.480064000000f, 0.9991120000000f, 0.006785400000f},
     {0.495971300000f, 0.9997482000000f, 0.006242800000f}, {0.512050100000f, 1.0000000000000f, 0.005749999000f},
     {0.528295900000f, 0.9998567000000f, 0.005303600000f}, {0.544691600000f, 0.9993046000000f, 0.004899800000f},
     {0.561209400000f, 0.9983255000000f, 0.004534200000f}, {0.577821500000f, 0.9968987000000f, 0.004202400000f},
     {0.594500000000f, 0.9950000000000f, 0.003900000000f}, {0.611220900000f, 0.9926005000000f, 0.003623200000f},
     {0.627975800000f, 0.9897426000000f, 0.003370600000f}, {0.644760200000f, 0.9864444000000f, 0.003141400000f},
     {0.661569700000f, 0.9827241000000f, 0.002934800000f}, {0.678400000000f, 0.9786000000000f, 0.002749999000f},
     {0.695239200000f, 0.9740837000000f, 0.002585200000f}, {0.712058600000f, 0.9691712000000f, 0.002438600000f},
     {0.728828400000f, 0.9638568000000f, 0.002309400000f}, {0.745518800000f, 0.9581349000000f, 0.002196800000f},
     {0.762100000000f, 0.9520000000000f, 0.002100000000f}, {0.778543200000f, 0.9454504000000f, 0.002017733000f},
     {0.794825600000f, 0.9384992000000f, 0.001948200000f}, {0.810926400000f, 0.9311628000000f, 0.001889800000f},
     {0.826824800000f, 0.9234576000000f, 0.001840933000f}, {0.842500000000f, 0.9154000000000f, 0.001800000000f},
     {0.857932500000f, 0.9070064000000f, 0.001766267000f}, {0.873081600000f, 0.8982772000000f, 0.001737800000f},
     {0.887894400000f, 0.8892048000000f, 0.001711200000f}, {0.902318100000f, 0.8797816000000f, 0.001683067000f},
     {0.916300000000f, 0.8700000000000f, 0.001650001000f}, {0.929799500000f, 0.8598613000000f, 0.001610133000f},
     {0.942798400000f, 0.8493920000000f, 0.001564400000f}, {0.955277600000f, 0.8386220000000f, 0.001513600000f},
     {0.967217900000f, 0.8275813000000f, 0.001458533000f}, {0.978600000000f, 0.8163000000000f, 0.001400000000f},
     {0.989385600000f, 0.8047947000000f, 0.001336667000f}, {0.999548800000f, 0.7930820000000f, 0.001270000000f},
     {1.009089200000f, 0.7811920000000f, 0.001205000000f}, {1.018006400000f, 0.7691547000000f, 0.001146667000f},
     {1.026300000000f, 0.7570000000000f, 0.001100000000f}, {1.033982700000f, 0.7447541000000f, 0.001068800000f},
     {1.040986000000f, 0.7324224000000f, 0.001049400000f}, {1.047188000000f, 0.7200036000000f, 0.001035600000f},
     {1.052466700000f, 0.7074965000000f, 0.001021200000f}, {1.056700000000f, 0.6949000000000f, 0.001000000000f},
     {1.059794400000f, 0.6822192000000f, 0.000968640000f}, {1.061799200000f, 0.6694716000000f, 0.000929920000f},
     {1.062806800000f, 0.6566744000000f, 0.000886880000f}, {1.062909600000f, 0.6438448000000f, 0.000842560000f},
     {1.062200000000f, 0.6310000000000f, 0.000800000000f}, {1.060735200000f, 0.6181555000000f, 0.000760960000f},
     {1.058443600000f, 0.6053144000000f, 0.000723680000f}, {1.055224400000f, 0.5924756000000f, 0.000685920000f},
     {1.050976800000f, 0.5796379000000f, 0.000645440000f}, {1.045600000000f, 0.5668000000000f, 0.000600000000f},
     {1.039036900000f, 0.5539611000000f, 0.000547866700f}, {1.031360800000f, 0.5411372000000f, 0.000491600000f},
     {1.022666200000f, 0.5283528000000f, 0.000435400000f}, {1.013047700000f, 0.5156323000000f, 0.000383466700f},
     {1.002600000000f, 0.5030000000000f, 0.000340000000f}, {0.991367500000f, 0.4904688000000f, 0.000307253300f},
     {0.979331400000f, 0.4780304000000f, 0.000283160000f}, {0.966491600000f, 0.4656776000000f, 0.000265440000f},
     {0.952847900000f, 0.4534032000000f, 0.000251813300f}, {0.938400000000f, 0.4412000000000f, 0.000240000000f},
     {0.923194000000f, 0.4290800000000f, 0.000229546700f}, {0.907244000000f, 0.4170360000000f, 0.000220640000f},
     {0.890502000000f, 0.4050320000000f, 0.000211960000f}, {0.872920000000f, 0.3930320000000f, 0.000202186700f},
     {0.854449900000f, 0.3810000000000f, 0.000190000000f}, {0.835084000000f, 0.3689184000000f, 0.000174213300f},
     {0.814946000000f, 0.3568272000000f, 0.000155640000f}, {0.794186000000f, 0.3447768000000f, 0.000135960000f},
     {0.772954000000f, 0.3328176000000f, 0.000116853300f}, {0.751400000000f, 0.3210000000000f, 0.000100000000f},
     {0.729583600000f, 0.3093381000000f, 0.000086133330f}, {0.707588800000f, 0.2978504000000f, 0.000074600000f},
     {0.685602200000f, 0.2865936000000f, 0.000065000000f}, {0.663810400000f, 0.2756245000000f, 0.000056933330f},
     {0.642400000000f, 0.2650000000000f, 0.000049999990f}, {0.621514900000f, 0.2547632000000f, 0.000044160000f},
     {0.601113800000f, 0.2448896000000f, 0.000039480000f}, {0.581105200000f, 0.2353344000000f, 0.000035720000f},
     {0.561397700000f, 0.2260528000000f, 0.000032640000f}, {0.541900000000f, 0.2170000000000f, 0.000030000000f},
     {0.522599500000f, 0.2081616000000f, 0.000027653330f}, {0.503546400000f, 0.1995488000000f, 0.000025560000f},
     {0.484743600000f, 0.1911552000000f, 0.000023640000f}, {0.466193900000f, 0.1829744000000f, 0.000021813330f},
     {0.447900000000f, 0.1750000000000f, 0.000020000000f}, {0.429861300000f, 0.1672235000000f, 0.000018133330f},
     {0.412098000000f, 0.1596464000000f, 0.000016200000f}, {0.394644000000f, 0.1522776000000f, 0.000014200000f},
     {0.377533300000f, 0.1451259000000f, 0.000012133330f}, {0.360800000000f, 0.1382000000000f, 0.000010000000f},
     {0.344456300000f, 0.1315003000000f, 0.000007733333f}, {0.328516800000f, 0.1250248000000f, 0.000005400000f},
     {0.313019200000f, 0.1187792000000f, 0.000003200000f}, {0.298001100000f, 0.1127691000000f, 0.000001333333f},
     {0.283500000000f, 0.1070000000000f, 0.000000000000f}, {0.269544800000f, 0.1014762000000f, 0.000000000000f},
     {0.256118400000f, 0.0961886400000f, 0.000000000000f}, {0.243189600000f, 0.0911229600000f, 0.000000000000f},
     {0.230727200000f, 0.0862648500000f, 0.000000000000f}, {0.218700000000f, 0.0816000000000f, 0.000000000000f},
     {0.207097100000f, 0.0771206400000f, 0.000000000000f}, {0.195923200000f, 0.0728255200000f, 0.000000000000f},
     {0.185170800000f, 0.0687100800000f, 0.000000000000f}, {0.174832300000f, 0.0647697600000f, 0.000000000000f},
     {0.164900000000f, 0.0610000000000f, 0.000000000000f}, {0.155366700000f, 0.0573962100000f, 0.000000000000f},
     {0.146230000000f, 0.0539550400000f, 0.000000000000f}, {0.137490000000f, 0.0506737600000f, 0.000000000000f},
     {0.129146700000f, 0.0475496500000f, 0.000000000000f}, {0.121200000000f, 0.0445800000000f, 0.000000000000f},
     {0.113639700000f, 0.0417587200000f, 0.000000000000f}, {0.106465000000f, 0.0390849600000f, 0.000000000000f},
     {0.099690440000f, 0.0365638400000f, 0.000000000000f}, {0.093330610000f, 0.0342004800000f, 0.000000000000f},
     {0.087400000000f, 0.0320000000000f, 0.000000000000f}, {0.081900960000f, 0.0299626100000f, 0.000000000000f},
     {0.076804280000f, 0.0280766400000f, 0.000000000000f}, {0.072077120000f, 0.0263293600000f, 0.000000000000f},
     {0.067686640000f, 0.0247080500000f, 0.000000000000f}, {0.063600000000f, 0.0232000000000f, 0.000000000000f},
     {0.059806850000f, 0.0218007700000f, 0.000000000000f}, {0.056282160000f, 0.0205011200000f, 0.000000000000f},
     {0.052971040000f, 0.0192810800000f, 0.000000000000f}, {0.049818610000f, 0.0181206900000f, 0.000000000000f},
     {0.046770000000f, 0.0170000000000f, 0.000000000000f}, {0.043784050000f, 0.0159037900000f, 0.000000000000f},
     {0.040875360000f, 0.0148371800000f, 0.000000000000f}, {0.038072640000f, 0.0138106800000f, 0.000000000000f},
     {0.035404610000f, 0.0128347800000f, 0.000000000000f}, {0.032900000000f, 0.0119200000000f, 0.000000000000f},
     {0.030564190000f, 0.0110683100000f, 0.000000000000f}, {0.028380560000f, 0.0102733900000f, 0.000000000000f},
     {0.026344840000f, 0.0095333110000f, 0.000000000000f}, {0.024452750000f, 0.0088461570000f, 0.000000000000f},
     {0.022700000000f, 0.0082100000000f, 0.000000000000f}, {0.021084290000f, 0.0076237810000f, 0.000000000000f},
     {0.019599880000f, 0.0070854240000f, 0.000000000000f}, {0.018237320000f, 0.0065914760000f, 0.000000000000f},
     {0.016987170000f, 0.0061384850000f, 0.000000000000f}, {0.015840000000f, 0.0057230000000f, 0.000000000000f},
     {0.014790640000f, 0.0053430590000f, 0.000000000000f}, {0.013831320000f, 0.0049957960000f, 0.000000000000f},
     {0.012948680000f, 0.0046764040000f, 0.000000000000f}, {0.012129200000f, 0.0043800750000f, 0.000000000000f},
     {0.011359160000f, 0.0041020000000f, 0.000000000000f}, {0.010629350000f, 0.0038384530000f, 0.000000000000f},
     {0.009938846000f, 0.0035890990000f, 0.000000000000f}, {0.009288422000f, 0.0033542190000f, 0.000000000000f},
     {0.008678854000f, 0.0031340930000f, 0.000000000000f}, {0.008110916000f, 0.0029290000000f, 0.000000000000f},
     {0.007582388000f, 0.0027381390000f, 0.000000000000f}, {0.007088746000f, 0.0025598760000f, 0.000000000000f},
     {0.006627313000f, 0.0023932440000f, 0.000000000000f}, {0.006195408000f, 0.0022372750000f, 0.000000000000f},
     {0.005790346000f, 0.0020910000000f, 0.000000000000f}, {0.005409826000f, 0.0019535870000f, 0.000000000000f},
     {0.005052583000f, 0.0018245800000f, 0.000000000000f}, {0.004717512000f, 0.0017035800000f, 0.000000000000f},
     {0.004403507000f, 0.0015901870000f, 0.000000000000f}, {0.004109457000f, 0.0014840000000f, 0.000000000000f},
     {0.003833913000f, 0.0013844960000f, 0.000000000000f}, {0.003575748000f, 0.0012912680000f, 0.000000000000f},
     {0.003334342000f, 0.0012040920000f, 0.000000000000f}, {0.003109075000f, 0.0011227440000f, 0.000000000000f},
     {0.002899327000f, 0.0010470000000f, 0.000000000000f}, {0.002704348000f, 0.0009765896000f, 0.000000000000f},
     {0.002523020000f, 0.0009111088000f, 0.000000000000f}, {0.002354168000f, 0.0008501332000f, 0.000000000000f},
     {0.002196616000f, 0.0007932384000f, 0.000000000000f}, {0.002049190000f, 0.0007400000000f, 0.000000000000f},
     {0.001910960000f, 0.0006900827000f, 0.000000000000f}, {0.001781438000f, 0.0006433100000f, 0.000000000000f},
     {0.001660110000f, 0.0005994960000f, 0.000000000000f}, {0.001546459000f, 0.0005584547000f, 0.000000000000f},
     {0.001439971000f, 0.0005200000000f, 0.000000000000f}, {0.001340042000f, 0.0004839136000f, 0.000000000000f},
     {0.001246275000f, 0.0004500528000f, 0.000000000000f}, {0.001158471000f, 0.0004183452000f, 0.000000000000f},
     {0.001076430000f, 0.0003887184000f, 0.000000000000f}, {0.000999949300f, 0.0003611000000f, 0.000000000000f},
     {0.000928735800f, 0.0003353835000f, 0.000000000000f}, {0.000862433200f, 0.0003114404000f, 0.000000000000f},
     {0.000800750300f, 0.0002891656000f, 0.000000000000f}, {0.000743396000f, 0.0002684539000f, 0.000000000000f},
     {0.000690078600f, 0.0002492000000f, 0.000000000000f}, {0.000640515600f, 0.0002313019000f, 0.000000000000f},
     {0.000594502100f, 0.0002146856000f, 0.000000000000f}, {0.000551864600f, 0.0001992884000f, 0.000000000000f},
     {0.000512429000f, 0.0001850475000f, 0.000000000000f}, {0.000476021300f, 0.0001719000000f, 0.000000000000f},
     {0.000442453600f, 0.0001597781000f, 0.000000000000f}, {0.000411511700f, 0.0001486044000f, 0.000000000000f},
     {0.000382981400f, 0.0001383016000f, 0.000000000000f}, {0.000356649100f, 0.0001287925000f, 0.000000000000f},
     {0.000332301100f, 0.0001200000000f, 0.000000000000f}, {0.000309758600f, 0.0001118595000f, 0.000000000000f},
     {0.000288887100f, 0.0001043224000f, 0.000000000000f}, {0.000269539400f, 0.0000973356000f, 0.000000000000f},
     {0.000251568200f, 0.0000908458700f, 0.000000000000f}, {0.000234826100f, 0.0000848000000f, 0.000000000000f},
     {0.000219171000f, 0.0000791466700f, 0.000000000000f}, {0.000204525800f, 0.0000738580000f, 0.000000000000f},
     {0.000190840500f, 0.0000689160000f, 0.000000000000f}, {0.000178065400f, 0.0000643026700f, 0.000000000000f},
     {0.000166150500f, 0.0000600000000f, 0.000000000000f}, {0.000155023600f, 0.0000559818700f, 0.000000000000f},
     {0.000144621900f, 0.0000522256000f, 0.000000000000f}, {0.000134909800f, 0.0000487184000f, 0.000000000000f},
     {0.000125852000f, 0.0000454474700f, 0.000000000000f}, {0.000117413000f, 0.0000424000000f, 0.000000000000f},
     {0.000109551500f, 0.0000395610400f, 0.000000000000f}, {0.000102224500f, 0.0000369151200f, 0.000000000000f},
     {0.000095394450f, 0.0000344486800f, 0.000000000000f}, {0.000089023900f, 0.0000321481600f, 0.000000000000f},
     {0.000083075270f, 0.0000300000000f, 0.000000000000f}, {0.000077512690f, 0.0000279912500f, 0.000000000000f},
     {0.000072313040f, 0.0000261135600f, 0.000000000000f}, {0.000067457780f, 0.0000243602400f, 0.000000000000f},
     {0.000062928440f, 0.0000227246100f, 0.000000000000f}, {0.000058706520f, 0.0000212000000f, 0.000000000000f},
     {0.000054770280f, 0.0000197785500f, 0.000000000000f}, {0.000051099180f, 0.0000184528500f, 0.000000000000f},
     {0.000047676540f, 0.0000172168700f, 0.000000000000f}, {0.000044485670f, 0.0000160645900f, 0.000000000000f},
     {0.000041509940f, 0.0000149900000f, 0.000000000000f}, {0.000038733240f, 0.0000139872800f, 0.000000000000f},
     {0.000036142030f, 0.0000130515500f, 0.000000000000f}, {0.000033723520f, 0.0000121781800f, 0.000000000000f},
     {0.000031464870f, 0.0000113625400f, 0.000000000000f}, {0.000029353260f, 0.0000106000000f, 0.000000000000f},
     {0.000027375730f, 0.0000098858770f, 0.000000000000f}, {0.000025524330f, 0.0000092173040f, 0.000000000000f},
     {0.000023793760f, 0.0000085923620f, 0.000000000000f}, {0.000022178700f, 0.0000080091330f, 0.000000000000f},
     {0.000020673830f, 0.0000074657000f, 0.000000000000f}, {0.000019272260f, 0.0000069595670f, 0.000000000000f},
     {0.000017966400f, 0.0000064879950f, 0.000000000000f}, {0.000016749910f, 0.0000060486990f, 0.000000000000f},
     {0.000015616480f, 0.0000056393960f, 0.000000000000f}, {0.000014559770f, 0.0000052578000f, 0.000000000000f},
     {0.000013573870f, 0.0000049017710f, 0.000000000000f}, {0.000012654360f, 0.0000045697200f, 0.000000000000f},
     {0.000011797230f, 0.0000042601940f, 0.000000000000f}, {0.000010998440f, 0.0000039717390f, 0.000000000000f},
     {0.000010253980f, 0.0000037029000f, 0.000000000000f}, {0.000009559646f, 0.0000034521630f, 0.000000000000f},
     {0.000008912044f, 0.0000032183020f, 0.000000000000f}, {0.000008308358f, 0.0000030003000f, 0.000000000000f},
     {0.000007745769f, 0.0000027971390f, 0.000000000000f}, {0.000007221456f, 0.0000026078000f, 0.000000000000f},
     {0.000006732475f, 0.0000024312200f, 0.000000000000f}, {0.000006276423f, 0.0000022665310f, 0.000000000000f},
     {0.000005851304f, 0.0000021130130f, 0.000000000000f}, {0.000005455118f, 0.0000019699430f, 0.000000000000f},
     {0.000005085868f, 0.0000018366000f, 0.000000000000f}, {0.000004741466f, 0.0000017122300f, 0.000000000000f},
     {0.000004420236f, 0.0000015962280f, 0.000000000000f}, {0.000004120783f, 0.0000014880900f, 0.000000000000f},
     {0.000003841716f, 0.0000013873140f, 0.000000000000f}, {0.000003581652f, 0.0000012934000f, 0.000000000000f},
     {0.000003339127f, 0.0000012058200f, 0.000000000000f}, {0.000003112949f, 0.0000011241430f, 0.000000000000f},
     {0.000002902121f, 0.0000010480090f, 0.000000000000f}, {0.000002705645f, 0.0000009770578f, 0.000000000000f},
     {0.000002522525f, 0.0000009109300f, 0.000000000000f}, {0.000002351726f, 0.0000008492513f, 0.000000000000f},
     {0.000002192415f, 0.0000007917212f, 0.000000000000f}, {0.000002043902f, 0.0000007380904f, 0.000000000000f},
     {0.000001905497f, 0.0000006881098f, 0.000000000000f}, {0.000001776509f, 0.0000006415300f, 0.000000000000f},
     {0.000001656215f, 0.0000005980895f, 0.000000000000f}, {0.000001544022f, 0.0000005575746f, 0.000000000000f},
     {0.000001439440f, 0.0000005198080f, 0.000000000000f}, {0.000001341977f, 0.0000004846123f, 0.000000000000f},
     {0.000001251141f, 0.0000004518100f, 0.000000000000f}},
    360.0f,
    830.0f};

static const TabulatedSpectrum<float> s_Illuminant_A = {
    {// CIE standard illuminant A, a typical tungsten-filament light with relative spectral power distribution of 2856K,
     // at 1nm resolution
     0.930483f, 0.967643f, 1.00597f, 1.04549f, 1.08623f, 1.12821f, 1.17147f, 1.21602f, 1.26188f, 1.3091f,  1.35769f,
     1.40768f,  1.4591f,   1.51198f, 1.56633f, 1.62219f, 1.67959f, 1.73855f, 1.7991f,  1.86127f, 1.92508f, 1.99057f,
     2.05776f,  2.12667f,  2.19734f, 2.2698f,  2.34406f, 2.42017f, 2.49814f, 2.57801f, 2.65981f, 2.74355f, 2.82928f,
     2.91701f,  3.00678f,  3.09861f, 3.19253f, 3.28857f, 3.38676f, 3.48712f, 3.58968f, 3.69447f, 3.80152f, 3.91085f,
     4.0225f,   4.13648f,  4.25282f, 4.37156f, 4.49272f, 4.61631f, 4.74238f, 4.87095f, 5.00204f, 5.13568f, 5.27189f,
     5.4107f,   5.55213f,  5.69622f, 5.84298f, 5.99244f, 6.14462f, 6.29955f, 6.45724f, 6.61774f, 6.78105f, 6.9472f,
     7.11621f,  7.28811f,  7.46292f, 7.64066f, 7.82135f, 8.00501f, 8.19167f, 8.38134f, 8.57404f, 8.7698f,  8.96864f,
     9.17056f,  9.37561f,  9.58378f, 9.7951f,  10.0096f, 10.2273f, 10.4481f, 10.6722f, 10.8996f, 11.1302f, 11.364f,
     11.6012f,  11.8416f,  12.0853f, 12.3324f, 12.5828f, 12.8366f, 13.0938f, 13.3543f, 13.6182f, 13.8855f, 14.1563f,
     14.4304f,  14.708f,   14.9891f, 15.2736f, 15.5616f, 15.853f,  16.148f,  16.4464f, 16.7484f, 17.0538f, 17.3628f,
     17.6753f,  17.9913f,  18.3108f, 18.6339f, 18.9605f, 19.2907f, 19.6244f, 19.9617f, 20.3026f, 20.647f,  20.995f,
     21.3465f,  21.7016f,  22.0603f, 22.4225f, 22.7883f, 23.1577f, 23.5307f, 23.9072f, 24.2873f, 24.6709f, 25.0581f,
     25.4489f,  25.8432f,  26.2411f, 26.6425f, 27.0475f, 27.456f,  27.8681f, 28.2836f, 28.7027f, 29.1253f, 29.5515f,
     29.9811f,  30.4142f,  30.8508f, 31.2909f, 31.7345f, 32.1815f, 32.632f,  33.0859f, 33.5432f, 34.004f,  34.4682f,
     34.9358f,  35.4068f,  35.8811f, 36.3588f, 36.8399f, 37.3243f, 37.8121f, 38.3031f, 38.7975f, 39.2951f, 39.796f,
     40.3002f,  40.8076f,  41.3182f, 41.832f,  42.3491f, 42.8693f, 43.3926f, 43.9192f, 44.4488f, 44.9816f, 45.5174f,
     46.0563f,  46.5983f,  47.1433f, 47.6913f, 48.2423f, 48.7963f, 49.3533f, 49.9132f, 50.476f,  51.0418f, 51.6104f,
     52.1818f,  52.7561f,  53.3332f, 53.9132f, 54.4958f, 55.0813f, 55.6694f, 56.2603f, 56.8539f, 57.4501f, 58.0489f,
     58.6504f,  59.2545f,  59.8611f, 60.4703f, 61.082f,  61.6962f, 62.3128f, 62.932f,  63.5535f, 64.1775f, 64.8038f,
     65.4325f,  66.0635f,  66.6968f, 67.3324f, 67.9702f, 68.6102f, 69.2525f, 69.8969f, 70.5435f, 71.1922f, 71.843f,
     72.4959f,  73.1508f,  73.8077f, 74.4666f, 75.1275f, 75.7903f, 76.4551f, 77.1217f, 77.7902f, 78.4605f, 79.1326f,
     79.8065f,  80.4821f,  81.1595f, 81.8386f, 82.5193f, 83.2017f, 83.8856f, 84.5712f, 85.2584f, 85.947f,  86.6372f,
     87.3288f,  88.0219f,  88.7165f, 89.4124f, 90.1097f, 90.8083f, 91.5082f, 92.2095f, 92.912f,  93.6157f, 94.3206f,
     95.0267f,  95.7339f,  96.4423f, 97.1518f, 97.8623f, 98.5739f, 99.2864f, 100.f,    100.715f, 101.43f,  102.146f,
     102.864f,  103.582f,  104.301f, 105.02f,  105.741f, 106.462f, 107.184f, 107.906f, 108.63f,  109.354f, 110.078f,
     110.803f,  111.529f,  112.255f, 112.982f, 113.709f, 114.436f, 115.164f, 115.893f, 116.622f, 117.351f, 118.08f,
     118.81f,   119.54f,   120.27f,  121.001f, 121.731f, 122.462f, 123.193f, 123.924f, 124.655f, 125.386f, 126.118f,
     126.849f,  127.58f,   128.312f, 129.043f, 129.774f, 130.505f, 131.236f, 131.966f, 132.697f, 133.427f, 134.157f,
     134.887f,  135.617f,  136.346f, 137.075f, 137.804f, 138.532f, 139.26f,  139.988f, 140.715f, 141.441f, 142.167f,
     142.893f,  143.618f,  144.343f, 145.067f, 145.79f,  146.513f, 147.235f, 147.957f, 148.678f, 149.398f, 150.117f,
     150.836f,  151.554f,  152.271f, 152.988f, 153.704f, 154.418f, 155.132f, 155.845f, 156.558f, 157.269f, 157.979f,
     158.689f,  159.397f,  160.104f, 160.811f, 161.516f, 162.221f, 162.924f, 163.626f, 164.327f, 165.028f, 165.726f,
     166.424f,  167.121f,  167.816f, 168.51f,  169.203f, 169.895f, 170.586f, 171.275f, 171.963f, 172.65f,  173.335f,
     174.019f,  174.702f,  175.383f, 176.063f, 176.741f, 177.419f, 178.094f, 178.769f, 179.441f, 180.113f, 180.783f,
     181.451f,  182.118f,  182.783f, 183.447f, 184.109f, 184.77f,  185.429f, 186.087f, 186.743f, 187.397f, 188.05f,
     188.701f,  189.35f,   189.998f, 190.644f, 191.288f, 191.931f, 192.572f, 193.211f, 193.849f, 194.484f, 195.118f,
     195.75f,   196.381f,  197.009f, 197.636f, 198.261f, 198.884f, 199.506f, 200.125f, 200.743f, 201.359f, 201.972f,
     202.584f,  203.195f,  203.803f, 204.409f, 205.013f, 205.616f, 206.216f, 206.815f, 207.411f, 208.006f, 208.599f,
     209.189f,  209.778f,  210.365f, 210.949f, 211.532f, 212.112f, 212.691f, 213.268f, 213.842f, 214.415f, 214.985f,
     215.553f,  216.12f,   216.684f, 217.246f, 217.806f, 218.364f, 218.92f,  219.473f, 220.025f, 220.574f, 221.122f,
     221.667f,  222.21f,   222.751f, 223.29f,  223.826f, 224.361f, 224.893f, 225.423f, 225.951f, 226.477f, 227.f,
     227.522f,  228.041f,  228.558f, 229.073f, 229.585f, 230.096f, 230.604f, 231.11f,  231.614f, 232.115f, 232.615f,
     233.112f,  233.606f,  234.099f, 234.589f, 235.078f, 235.564f, 236.047f, 236.529f, 237.008f, 237.485f, 237.959f,
     238.432f,  238.902f,  239.37f,  239.836f, 240.299f, 240.76f,  241.219f, 241.675f, 242.13f,  242.582f, 243.031f,
     243.479f,  243.924f,  244.367f, 244.808f, 245.246f, 245.682f, 246.116f, 246.548f, 246.977f, 247.404f, 247.829f,
     248.251f,  248.671f,  249.089f, 249.505f, 249.918f, 250.329f, 250.738f, 251.144f, 251.548f, 251.95f,  252.35f,
     252.747f,  253.142f,  253.535f, 253.925f, 254.314f, 254.7f,   255.083f, 255.465f, 255.844f, 256.221f, 256.595f,
     256.968f,  257.338f,  257.706f, 258.071f, 258.434f, 258.795f, 259.154f, 259.511f, 259.865f, 260.217f, 260.567f,
     260.914f,  261.259f,  261.602f},
    300.f,
    830.f};

static const TabulatedSpectrum<float> s_Illuminant_B = {
    {// CIE standard illuminant B (obsolete)
     2.40,   4.00,   5.60,   7.60,   9.60,   12.40,  15.20,  18.80,  22.40,  26.85,  31.30,  36.18,  41.30,
     46.62,  52.10,  57.70,  63.20,  68.37,  73.10,  77.31,  80.80,  83.44,  85.40,  86.88,  88.30,  90.08,
     92.00,  93.75,  95.20,  96.23,  96.50,  95.71,  94.20,  92.37,  90.70,  89.65,  89.50,  90.43,  92.20,
     94.46,  96.90,  99.16,  101.00, 102.20, 102.80, 102.92, 102.60, 101.90, 101.00, 100.07, 99.20,  98.44,
     98.00,  98.08,  98.50,  99.06,  99.70,  100.36, 101.00, 101.56, 102.20, 103.05, 103.90, 104.59, 105.00,
     105.08, 104.90, 104.55, 103.90, 102.84, 101.60, 100.38, 99.10,  97.70,  96.20,  94.60,  92.90,  91.10,
     89.40,  88.00,  86.90,  85.90,  85.20,  84.80,  84.70,  84.90,  85.40},
    340.f,
    770.f};

static const TabulatedSpectrum<float> s_Illuminant_C = {
    {33.00f,  39.92f,  47.40f,  55.17f,  63.30f,  71.81f,  80.60f,  89.53f,  98.10f,  105.80f, 112.40f, 117.75f,
     121.50f, 123.45f, 124.00f, 123.60f, 123.10f, 123.30f, 123.80f, 124.09f, 123.90f, 122.92f, 120.70f, 116.90f,
     112.10f, 106.98f, 102.30f, 98.81f,  96.90f,  96.78f,  98.00f,  99.94f,  102.10f, 103.95f, 105.20f, 105.67f,
     105.30f, 104.11f, 102.30f, 100.15f, 97.80f,  95.43f,  93.20f,  91.22f,  89.70f,  88.83f,  88.40f,  88.19f,
     88.10f,  88.06f,  88.00f,  87.86f,  87.80f,  87.99f,  88.20f,  88.20f,  87.90f,  87.22f,  86.30f,  85.30f,
     84.00f,  82.21f,  80.20f,  78.24f,  76.30f,  74.36f,  72.40f,  70.40f,  68.30f,  66.30f,  64.40f,  62.80f,
     61.50f,  60.20f,  59.20f,  58.50f,  58.10f,  58.00f,  58.20f,  58.50f,  59.10f},
    380.f,
    780.f};

static const TabulatedSpectrum<float> s_Illuminant_E = {{100.0f, 100.0f}, 300.f, 830.f};

// Reference whites used in the common color spaces below
static float2 s_white_point_values[] = {
    {0.32168f, 0.33767f}, // ACES: Academy Color Encoding System, ~6000k
    {0.34567f, 0.35850f}, // D50:	horizon light, ICC profile PCS
    {0.33242f, 0.34743f}, // D55:	mid-morning / mid-afternoon daylight
    {0.31271f, 0.32902f}, // D65:	noon daylight: television, sRGB color space
    {0.29902f, 0.31485f}, // D75:	North sky daylight
    {0.28315f, 0.29711f}, // D93:	high-efficiency blue phosphor monitors, BT.2035
    {0.3140f, 0.3510f},   // DCI: ~6300 K
    {0.31310f, 0.33727f}, // F1:	daylight fluorescent
    {0.37208f, 0.37529f}, // F2:	cool white fluorescent
    {0.40910f, 0.39430f}, // F3:	white fluorescent
    {0.44018f, 0.40329f}, // F4:	warm white fluorescent
    {0.31379f, 0.34531f}, // F5:	daylight fluorescent
    {0.37790f, 0.38835f}, // F6:	light white fluorescent
    {0.31292f, 0.32933f}, // F7:	D65 simulator, daylight simulator
    {0.34588f, 0.35875f}, // F8:	D50 simulator, Sylvania F40 Design 50
    {0.37417f, 0.37281f}, // F9:	cool white deluxe fluorescent
    {0.34609f, 0.35986f}, // F10:	Philips TL85, Ultralume 50
    {0.38052f, 0.37713f}, // F11:	Philips TL84, Ultralume 40
    {0.43695f, 0.40441f}, // F12:	Philips TL83, Ultralume 30
    {0.44757f, 0.40745f}, // A:	incandescent / tungsten
    {0.34842f, 0.35161f}, // B:	obsolete, direct sunlight at noon
    {0.31006f, 0.31616f}, // C:	obsolete, average / North sky daylight
    {0.33333f, 0.33333f}, // E:	equal energy
    {0.31271f, 0.32902f}, // Unspecified = D65
    {std::numeric_limits<float>::quiet_NaN(), std::numeric_limits<float>::quiet_NaN()}};

static const char *s_white_point_names[] = {"ACES",             // ACES: Academy Color Encoding System, ~6000k
                                            "D50",              // D50: horizon light, ICC profile PCS
                                            "D55",              // D55: mid-morning / mid-afternoon daylight
                                            "D65",              // D65: noon daylight: television, sRGB color space
                                            "D75",              // D75: North sky daylight
                                            "D93",              // D93: high-efficiency blue phosphor monitors, BT.2035
                                            "DCI",              // DCI: ~6300 K
                                            "F1",               // F1: daylight fluorescent
                                            "F2",               // F2: cool white fluorescent
                                            "F3",               // F3: white fluorescent
                                            "F4",               // F4: warm white fluorescent
                                            "F5",               // F5: daylight fluorescent
                                            "F6",               // F6: light white fluorescent
                                            "F7",               // F7: D65 simulator, daylight simulator
                                            "F8",               // F8: D50 simulator, Sylvania F40 Design 50
                                            "F9",               // F9: cool white deluxe fluorescent
                                            "F10",              // F10: Philips TL85, Ultralume 50
                                            "F11",              // F11: Philips TL84, Ultralume 40
                                            "F12",              // F12: Philips TL83, Ultralume 30
                                            "Std Illuminant A", // A: incandescent / tungsten
                                            "Std Illuminant B", // B: obsolete, direct sunlight at noon
                                            "Std Illuminant C", // C: obsolete, average / North sky daylight
                                            "Std Illuminant E", // E: equal energy
                                            "Unspecified (Assuming D65)", // Unspecified = D65
                                            "Custom",                     // Custom/NaN
                                            nullptr};

// Static array of chromaticities for each ColorGamut value
static const Chromaticities s_gamut_chromaticities[] = {
    {{0.6400f, 0.3300f}, {0.3000f, 0.6000f}, {0.1500f, 0.0600f}, s_white_point_values[WhitePoint_D65]},
    {{0.6700f, 0.3300f}, {0.2100f, 0.7100f}, {0.1400f, 0.0800f}, s_white_point_values[WhitePoint_C]},
    {{0.6400f, 0.3300f}, {0.2900f, 0.6000f}, {0.1500f, 0.0600f}, s_white_point_values[WhitePoint_D65]},
    {{0.6300f, 0.3400f}, {0.3100f, 0.5950f}, {0.1550f, 0.0700f}, s_white_point_values[WhitePoint_D65]},
    {{0.6810f, 0.3190f}, {0.2430f, 0.6920f}, {0.1450f, 0.0490f}, s_white_point_values[WhitePoint_C]},
    {{0.7080f, 0.2920f}, {0.1700f, 0.7970f}, {0.1310f, 0.0460f}, s_white_point_values[WhitePoint_D65]},
    {{0.7350f, 0.2650f}, {0.2740f, 0.7170f}, {0.1670f, 0.0090f}, s_white_point_values[WhitePoint_E]},
    {{0.6800f, 0.3200f}, {0.2650f, 0.6900f}, {0.1500f, 0.0600f}, s_white_point_values[WhitePoint_DCI]},
    {{0.6800f, 0.3200f}, {0.2650f, 0.6900f}, {0.1500f, 0.0600f}, s_white_point_values[WhitePoint_D65]},
    {{0.6300f, 0.3400f}, {0.2950f, 0.6050f}, {0.1550f, 0.0770f}, s_white_point_values[WhitePoint_D65]},
    {{0.73470f, 0.26530f}, {0.00000f, 1.00000f}, {0.00010f, -0.07700f}, s_white_point_values[WhitePoint_ACES]},
    {{0.713f, 0.293f}, {0.165f, 0.830f}, {0.128f, 0.044f}, s_white_point_values[WhitePoint_ACES]},
    {{0.6400f, 0.3300f}, {0.2100f, 0.7100f}, {0.1500f, 0.0600f}, s_white_point_values[WhitePoint_D65]},
    {{0.7347f, 0.2653f}, {0.1596f, 0.8404f}, {0.0366f, 0.0001f}, s_white_point_values[WhitePoint_D50]},
    {{1.f, 0.f}, {0.f, 1.f}, {0.f, 0.f}, s_white_point_values[WhitePoint_E]},
    {{0.6400f, 0.3300f}, {0.3000f, 0.6000f}, {0.1500f, 0.0600f}, s_white_point_values[WhitePoint_D65]}
    // ColorGamut_Custom (should not be used, throw below)
};
static const char *s_gamut_names[ColorGamut_Count + 1] = {"sRGB/BT.709",
                                                          "BT.470 M/NTSC",
                                                          "BT.470 BG/PAL/SECAM",
                                                          "SMPTE ST 170/240",
                                                          "Generic film",
                                                          "BT.2020/BT.2100",
                                                          "SMPTE ST 428-1",
                                                          "DCI P3/SMPTE RP 431",
                                                          "Display P3/SMPTE EG 432",
                                                          "CICP 22",
                                                          "ACES AP0",
                                                          "ACEScg AP1",
                                                          "Adobe RGB",
                                                          "ProPhoto RGB",
                                                          "CIE 1931 XYZ",
                                                          "Unspecified (Assuming sRGB/BT.709)",
                                                          "Custom",
                                                          nullptr};

static const char *s_transfer_function_names[TransferFunction_Count + 1] = {
    "Unknown (Assuming sRGB)", // TransferFunction_Unknown
    "Linear",                  // TransferFunction_Linear
    "Gamma",                   // TransferFunction_Gamma
    "sRGB IEC61966-2.1",       // TransferFunction_sRGB
    "BT.709/2020",             // TransferFunction_ITU
    "BT.2100 PQ",              // TransferFunction_BT2100_PQ
    "BT.2100 HLG",             // TransferFunction_BT2100_HLG
    "SMPTE ST 240",            // TransferFunction_ST240
    "Log100",                  // TransferFunction_Log100
    "Log100 Sqrt10",           // TransferFunction_Log100_Sqrt10
    "IEC 61966-2-4",           // TransferFunction_IEC61966_2_4
    "DCI-P3",                  // TransferFunction_DCI_P3
    nullptr};

float2 white_point(WhitePoint wp)
{
    if (wp >= WhitePoint_Custom)
        return s_white_point_values[WhitePoint_Custom];
    return s_white_point_values[wp];
}

WhitePoint named_white_point(float2 wp)
{
    for (WhitePoint_ i = WhitePoint_FirstNamed; i <= WhitePoint_LastNamed; ++i)
    {
        if (approx_equal(wp, s_white_point_values[i]))
            return static_cast<WhitePoint>(i);
    }
    // Return custom for unrecognized
    return WhitePoint_Custom;
}

const char *white_point_name(WhitePoint wp) { return s_white_point_names[wp]; }

const char **white_point_names() { return s_white_point_names; }

const char *color_gamut_name(const ColorGamut primaries)
{
    if (primaries >= ColorGamut_Custom)
        return s_gamut_names[ColorGamut_Custom];
    return s_gamut_names[primaries];
}

const char **color_gamut_names() { return s_gamut_names; }

Chromaticities gamut_chromaticities(ColorGamut primaries)
{
    if (primaries < 0 || primaries >= ColorGamut_Custom)
        throw std::invalid_argument("Unrecognized ColorGamut value");
    return s_gamut_chromaticities[primaries];
}

Chromaticities chromaticities_from_cicp(int cicp)
{
    switch (cicp)
    {
    case 1: return s_gamut_chromaticities[ColorGamut_sRGB_BT709];
    case 2: return s_gamut_chromaticities[ColorGamut_Unspecified];
    case 4: return s_gamut_chromaticities[ColorGamut_BT470M];
    case 5: return s_gamut_chromaticities[ColorGamut_BT470BG];
    case 6: [[fallthrough]];
    case 7: return s_gamut_chromaticities[ColorGamut_SMPTE170M_240M];
    case 8: return s_gamut_chromaticities[ColorGamut_Film];
    case 9: return s_gamut_chromaticities[ColorGamut_BT2020_2100];
    case 10: return s_gamut_chromaticities[ColorGamut_SMPTE428];
    case 11: return s_gamut_chromaticities[ColorGamut_DCI_P3_SMPTE431];
    case 12: return s_gamut_chromaticities[ColorGamut_Display_P3_SMPTE432];
    case 22: return s_gamut_chromaticities[ColorGamut_CICP_22];
    default: throw std::invalid_argument("Unrecognized or unsupported CICP value for chromaticities");
    }
}

int chromaticities_to_cicp(const Chromaticities &chr)
{
    for (int cicp : {1, 2, 4, 5, 6, 7, 8, 9, 10, 11, 12, 22})
        if (approx_equal(chr, chromaticities_from_cicp(cicp)))
            return cicp;

    return -1;
}

ColorGamut named_color_gamut(const Chromaticities &chr)
{
    for (ColorGamut_ i = ColorGamut_FirstNamed; i <= ColorGamut_LastNamed; ++i)
    {
        if (approx_equal(chr, gamut_chromaticities(static_cast<ColorGamut>(i))))
            return static_cast<ColorGamut>(i);
    }
    // Return custom for unrecognized
    return ColorGamut_Custom;
}

string transfer_function_name(TransferFunction tf, float gamma)
{
    if (tf == TransferFunction_Gamma)
        return fmt::format("{} (={})", s_transfer_function_names[TransferFunction_Gamma], float(1.0 / gamma));
    else if (tf < TransferFunction_Unknown || tf >= TransferFunction_Count)
        return s_transfer_function_names[TransferFunction_Unknown];
    else
        return s_transfer_function_names[tf];
}

TransferFunction transfer_function_from_cicp(int cicp, float *gamma)
{
    switch (cicp)
    {
    case 1: [[fallthrough]];
    case 6: [[fallthrough]];
    case 12: [[fallthrough]];
    case 14: [[fallthrough]];
    case 15: return TransferFunction_ITU;
    case 4:
        if (gamma)
            *gamma = 2.2f;
        return TransferFunction_Gamma;
    case 5:
        if (gamma)
            *gamma = 2.8f;
        return TransferFunction_Gamma;
    case 7: return TransferFunction_ST240;
    case 8: return TransferFunction_Linear;
    case 9: return TransferFunction_Log100;
    case 10: return TransferFunction_Log100_Sqrt10;
    case 11: return TransferFunction_IEC61966_2_4;
    case 13: return TransferFunction_sRGB;
    case 16: return TransferFunction_BT2100_PQ;
    case 17: return TransferFunction_DCI_P3;
    case 18: return TransferFunction_BT2100_HLG;
    default: return TransferFunction_Unknown;
    }
}

int transfer_function_to_cicp(TransferFunction tf, float gamma)
{
    switch (tf)
    {
    case TransferFunction_ITU: return 1; // Also covers 6, 12, 14, 15 in from_cicp
    case TransferFunction_Gamma:
        if (gamma == 2.2f)
            return 4;
        else if (gamma == 2.8f)
            return 5;
        else
            return 0; // Unknown gamma
    case TransferFunction_ST240: return 7;
    case TransferFunction_Linear: return 8;
    case TransferFunction_Log100: return 9;
    case TransferFunction_Log100_Sqrt10: return 10;
    case TransferFunction_IEC61966_2_4: return 11;
    case TransferFunction_sRGB: return 13;
    case TransferFunction_BT2100_PQ: return 16;
    case TransferFunction_DCI_P3: return 17;
    case TransferFunction_BT2100_HLG: return 18;
    default: return 0; // Unknown or unsupported
    }
}

float3x3 RGB_to_XYZ(const Chromaticities &chroma, float Y)
{
    // Adapted from ImfChromaticities.cpp
    //

    //
    // For an explanation of how the color conversion matrix is derived,
    // see Roy Hall, "Illumination and Color in Computer Generated Imagery",
    // Springer-Verlag, 1989, chapter 3, "Perceptual Response"; and
    // Charles A. Poynton, "A Technical Introduction to Digital Video",
    // John Wiley & Sons, 1996, chapter 7, "Color science for video".
    //

    //
    // X and Z values of RGB value (1, 1, 1), or "white"
    //

    // prevent a division that rounds to zero
    if (std::abs(chroma.white.y) <= 1.f && std::abs(chroma.white.x * Y) >= std::abs(chroma.white.y) * FLT_MAX)
    {
        throw std::invalid_argument("Bad chromaticities: white.y cannot be zero");
    }

    float X = chroma.white.x * Y / chroma.white.y;
    float Z = (1 - chroma.white.x - chroma.white.y) * Y / chroma.white.y;

    //
    // Scale factors for matrix rows, compute numerators and common denominator
    //

    float d = chroma.red.x * (chroma.blue.y - chroma.green.y) + chroma.blue.x * (chroma.green.y - chroma.red.y) +
              chroma.green.x * (chroma.red.y - chroma.blue.y);

    float SrN =
        (X * (chroma.blue.y - chroma.green.y) - chroma.green.x * (Y * (chroma.blue.y - 1) + chroma.blue.y * (X + Z)) +
         chroma.blue.x * (Y * (chroma.green.y - 1) + chroma.green.y * (X + Z)));

    float SgN =
        (X * (chroma.red.y - chroma.blue.y) + chroma.red.x * (Y * (chroma.blue.y - 1) + chroma.blue.y * (X + Z)) -
         chroma.blue.x * (Y * (chroma.red.y - 1) + chroma.red.y * (X + Z)));

    float SbN =
        (X * (chroma.green.y - chroma.red.y) - chroma.red.x * (Y * (chroma.green.y - 1) + chroma.green.y * (X + Z)) +
         chroma.green.x * (Y * (chroma.red.y - 1) + chroma.red.y * (X + Z)));

    if (std::abs(d) < 1.f && (std::abs(SrN) >= std::abs(d) * FLT_MAX || std::abs(SgN) >= std::abs(d) * FLT_MAX ||
                              std::abs(SbN) >= std::abs(d) * FLT_MAX))
    {
        // cannot generate matrix if all RGB primaries have the same y value
        // or if they all have the an x value of zero
        // in both cases, the primaries are colinear, which makes them unusable
        throw std::invalid_argument("Bad chromaticities: RGBtoXYZ matrix is degenerate");
    }

    float Sr = SrN / d;
    float Sg = SgN / d;
    float Sb = SbN / d;

    //
    // Assemble the matrix
    //

    float3x3 M{la::identity};

    M[0][0] = Sr * chroma.red.x;
    M[0][1] = Sr * chroma.red.y;
    M[0][2] = Sr * (1 - chroma.red.x - chroma.red.y);

    M[1][0] = Sg * chroma.green.x;
    M[1][1] = Sg * chroma.green.y;
    M[1][2] = Sg * (1 - chroma.green.x - chroma.green.y);

    M[2][0] = Sb * chroma.blue.x;
    M[2][1] = Sb * chroma.blue.y;
    M[2][2] = Sb * (1 - chroma.blue.x - chroma.blue.y);

    // M[3][3] = 1.f;

    return M;
}

bool color_conversion_matrix(float3x3 &M, const Chromaticities &src, const Chromaticities &dst,
                             AdaptationMethod CAT_method)
{
    try
    {
        if (src == dst)
        {
            // The file already contains data in the target colorspace.
            // color conversion is not necessary.
            M = float3x3{la::identity};
            return false;
        }

        //
        // Create a matrix that transforms colors from the
        // RGB space of the input file into the target space
        // using a color adaptation transform to move the
        // white point.
        //

        float3x3 CAT{la::identity}; // chromatic adaptation matrix
        if (CAT_method > 0 && CAT_method <= 3 && src.white != dst.white)
        {
            // the cone primary response matrices (and their inverses) for 3 different methods
            static const float3x3 CPM[3] = {{{1.f, 0.f, 0.f}, // XYZ scaling
                                             {0.f, 1.f, 0.f},
                                             {0.f, 0.f, 1.f}},
                                            {{0.895100f, -0.750200f, 0.038900f}, // Bradford
                                             {0.266400f, 1.713500f, -0.068500f},
                                             {-0.161400f, 0.036700f, 1.029600f}},
                                            {{0.4002400f, -0.2263000f, 0.0000000f}, // Von Kries
                                             {0.7076000f, 1.1653200f, 0.0000000f},
                                             {-0.0808100f, 0.0457000f, 0.9182200f}}};
            static const float3x3 invCPM[3]{{{1.f, 0.f, 0.f}, //
                                             {0.f, 1.f, 0.f}, //
                                             {0.f, 0.f, 1.f}},
                                            {{0.986993f, 0.432305f, -0.008529f}, //
                                             {-0.147054f, 0.518360f, 0.040043f}, //
                                             {0.159963f, 0.049291f, 0.968487f}},
                                            {{1.8599364f, 0.3611914f, 0.0000000f},  //
                                             {-1.1293816f, 0.6388125f, 0.0000000f}, //
                                             {0.2198974f, -0.0000064f, 1.0890636f}}};
            //
            // Convert the white points of the two RGB spaces to XYZ
            //

            float  fx = src.white.x;
            float  fy = src.white.y;
            float3 src_neutral_XYZ(fx / fy, 1, (1 - fx - fy) / fy);

            float  ax = dst.white.x;
            float  ay = dst.white.y;
            float3 dst_neutral_XYZ(ax / ay, 1, (1 - ax - ay) / ay);

            //
            // Compute the CAT
            //

            float3 ratio(mul(CPM[CAT_method - 1], dst_neutral_XYZ) / mul(CPM[CAT_method - 1], src_neutral_XYZ));

            float3x3 ratio_mat({ratio[0], 0.f, 0.f}, {0.f, ratio[1], 0.f}, {0.f, 0.f, ratio[2]});

            CAT = mul(invCPM[CAT_method - 1], ratio_mat, CPM[CAT_method - 1]);
        }

        //
        // Build a combined file-RGB-to-target-RGB conversion matrix
        //

        M = mul(XYZ_to_RGB(dst, 1), CAT, RGB_to_XYZ(src, 1));

        return true;
    }
    catch (...)
    {
        return false;
    }
}

Chromaticities primaries_from_matrix(const float3x3 &rgb_to_XYZ)
{
    Chromaticities result;
    // Multiplying the matrix by [1,0,0], [0,1,0], or [0,0,1] gives the XYZ values of the primaries.
    // Hence, the columns of the matrix are XYZ values of the primaries.
    // Divide each by its sum to get corresponding chromaticities.
    result.red   = rgb_to_XYZ.x.xy() / sum(rgb_to_XYZ.x);
    result.green = rgb_to_XYZ.y.xy() / sum(rgb_to_XYZ.y);
    result.blue  = rgb_to_XYZ.z.xy() / sum(rgb_to_XYZ.z);

    // Multiplying the matrix by full-intensity for each primary [1,1,1] gives us XYZ of white.
    // Hence, the sum of the columns is the XYZ of white.
    // Divide that by the sum of its components to get its chromaticity;
    float3 wpXYZ = rgb_to_XYZ.x + rgb_to_XYZ.y + rgb_to_XYZ.z;
    result.white = wpXYZ.xy() / sum(wpXYZ);
    return result;
}

float3 YC_to_RGB(float3 input, float3 Yw)
{
    if (input[0] == 0.f && input[2] == 0.f)
        //
        // Special case -- both chroma channels are 0.  To avoid
        // rounding errors, we explicitly set the output R, G and B
        // channels equal to the input luminance.
        //
        return float3(input[1], input[1], input[1]);

    float Y = input[1];
    float r = (input[0] + 1.f) * input[1];
    float b = (input[2] + 1.f) * input[1];
    float g = (Y - r * Yw.x - b * Yw.z) / Yw.y;

    return float3(r, g, b);
}

float3 RGB_to_YC(float3 input, float3 Yw)
{
    //
    // Conversion to YCA works only if R, G and B are finite and non-negative.
    //
    float3 output;
    if (!std::isfinite(input[0]) || input[0] < 0.f)
        input[0] = 0;
    if (!std::isfinite(input[1]) || input[1] < 0.f)
        input[1] = 0;
    if (!std::isfinite(input[2]) || input[2] < 0.f)
        input[2] = 0;

    if (input[0] == input[1] && input[1] == input[2])
    {
        //
        // Special case -- R, G and B are equal. To avoid rounding
        // errors, we explicitly set the output luminance channel
        // to G, and the chroma channels to 0.
        //
        // The special cases here and in YCtoRGB() ensure that
        // converting black-and white images from RGB to YC and
        // back is lossless.
        //

        output[0] = 0;
        output[1] = input[1];
        output[2] = 0;
    }
    else
    {
        output[1] = dot(input, Yw);
        float Y   = output[1];
        input[0]  = (std::abs(input[0] - Y) < FLT_MAX * Y) ? (input[0] - Y) / Y : 0;
        input[2]  = (std::abs(input[2] - Y) < FLT_MAX * Y) ? (input[2] - Y) / Y : 0;
    }
    return output;
}

const float3x3 &sRGB_to_XYZ()
{
    static const float3x3 M = RGB_to_XYZ(Chromaticities{}, 1.f);
    return M;
}

const float3x3 &XYZ_to_sRGB()
{
    static const float3x3 M = XYZ_to_RGB(Chromaticities{}, 1.f);
    return M;
}

const float3 &sRGB_Yw()
{
    static const float3 Yw = computeYw(Chromaticities{});
    return Yw;
}

Color3 linear_to_sRGB(const Color3 &c) { return la::apply(linear_to_sRGB<float>, c); }
Color4 linear_to_sRGB(const Color4 &c) { return {linear_to_sRGB(c.xyz()), c.w}; }
Color3 sRGB_to_linear(const Color3 &c) { return la::apply(sRGB_to_linear<float>, c); }
Color4 sRGB_to_linear(const Color4 &c) { return {sRGB_to_linear(c.xyz()), c.w}; }

Color3 linear_to_gamma(const Color3 &c, const Color3 &inv_gamma)
{
    return la::apply(linear_to_gamma<float>, c, inv_gamma);
}
Color4 linear_to_gamma(const Color4 &c, const Color3 &inv_gamma) { return {linear_to_gamma(c.xyz(), inv_gamma), c.w}; }

void xyYToXZ(float *X, float *Z, float x, float y, float Y)
{
    if (Y == 0.0f)
    {
        *X = 0.0f;
        *Z = 0.0f;
    }
    else
    {
        *X = x * Y;
        *Z = (1.0f - x - y) * Y / y;
    }
}

float2 Kelvin_to_xy(float T)
{
    if (T < 1667.f || T > 25000.f)
        return {std::numeric_limits<float>::quiet_NaN(), std::numeric_limits<float>::quiet_NaN()};

    float xc;
    if (T <= 4000.f)
        xc = -0.2661239e9f / (T * T * T) - 0.2343589e6f / (T * T) + 0.8776956e3f / T + 0.179910f;
    else
        xc = -3.0258469e9f / (T * T * T) + 2.1070379e6f / (T * T) + 0.2226347e3f / T + 0.240390f;

    float yc;
    if (T <= 2222.f)
        yc = -1.1063814f * xc * xc * xc - 1.34811020f * xc * xc + 2.18555832f * xc - 0.20219683f;
    else if (T <= 4000.f)
        yc = -0.9549476f * xc * xc * xc - 1.37418593f * xc * xc + 2.09137015f * xc - 0.16748867f;
    else
        yc = 3.0817580f * xc * xc * xc - 5.87338670f * xc * xc + 3.75112997f * xc - 0.37001483f;

    return {xc, yc};
}

float2 daylight_to_xy(float T)
{
    // Rectify CCT as described in the spec
    T = T * (1.438776877f / 1.4380f);

    float xD;
    if (T >= 4000.f && T <= 7000.f)
    {
        xD = 0.244063f + 0.09911f * (1000.f / T) + 2.9678f * (1000000.f / (T * T)) -
             4.6070f * (1000000000.f / (T * T * T));
    }
    else if (T > 7000.f && T <= 25000.f)
    {
        xD = 0.237040f + 0.24748f * (1000.f / T) + 1.9018f * (1000000.f / (T * T)) -
             2.0064f * (1000000000.f / (T * T * T));
    }
    else
    {
        // Out of range, return NaN
        return {std::numeric_limits<float>::quiet_NaN(), std::numeric_limits<float>::quiet_NaN()};
    }

    float yD = -3.000f * xD * xD + 2.870f * xD - 0.275f;
    return {xD, yD};
}

const TabulatedSpectrum<float> &white_point_spectrum(WhitePoint wp)
{
    // The D-series illuminants are defined in terms of three basis functions stored in s_CIE_D_bases
    // The weights are chosen based on the CCT.
    // See https://en.wikipedia.org/wiki/Standard_illuminant#Computation
    auto DXX = [](float T)
    {
        TabulatedSpectrum<float> illum;

        float2 xy = daylight_to_xy(T);
        float  xD = xy.x, yD = xy.y;
        float  M  = 0.0241f + 0.2562f * xD - 0.7341f * yD;
        float  M1 = (-1.3515f - 1.7703f * xD + 5.9114f * yD) / M;
        float  M2 = (0.0300f - 31.4424f * xD + 30.0717f * yD) / M;
        illum.values.resize(s_CIE_D_bases.values.size());
        illum.min_wavelength = s_CIE_D_bases.min_wavelength;
        illum.max_wavelength = s_CIE_D_bases.max_wavelength;
        for (size_t j = 0; j < s_CIE_D_bases.values.size(); ++j)
        {
            float S0        = s_CIE_D_bases.values[j][0];
            float S1        = s_CIE_D_bases.values[j][1];
            float S2        = s_CIE_D_bases.values[j][2];
            illum.values[j] = S0 + M1 * S1 + M2 * S2;
        }
        return illum;
    };

    switch (wp)
    {
    case WhitePoint_D50:
    {
        const static auto D50 = DXX(5000.f);
        return D50;
    }
    case WhitePoint_D55:
    {
        const static auto D55 = DXX(5500.f);
        return D55;
    }
    case WhitePoint_D65:
    {
        const static auto D65 = DXX(6500.f);
        return D65;
    }
    case WhitePoint_D75:
    {
        const static auto D75 = DXX(7500.f);
        return D75;
    }
    case WhitePoint_D93:
    {
        const static auto D93 = DXX(9300.f);
        return D93;
    }
    case WhitePoint_A: return s_Illuminant_A;
    case WhitePoint_B: return s_Illuminant_B;
    case WhitePoint_C: return s_Illuminant_C;
    case WhitePoint_E: return s_Illuminant_E;
    default:
    {
        static TabulatedSpectrum<float> empty{};
        return empty; // Return an empty spectrum for unrecognized white points
    }
    }
}

const TabulatedSpectrum<float3> &CIE_XYZ_spectra() { return s_CIE_xyz; }

void to_linear(float *r, float *g, float *b, int num_pixels, int num_channels, TransferFunction tf, float gamma,
               int stride)
{
    if (tf == TransferFunction_BT2100_HLG && num_channels == 3)
    {
        // HLG needs to operate on all three channels at once
        parallel_for(blocked_range<int>(0, num_pixels, 1024 * 1024),
                     [r, g, b, stride](int start, int end, int, int)
                     {
                         for (int i = start; i < end; ++i)
                         {
                             auto rgb      = EOTF_BT2100_HLG(float3{r[i * stride], g[i * stride], b[i * stride]});
                             r[i * stride] = rgb[0] / 255.f;
                             g[i * stride] = rgb[1] / 255.f;
                             b[i * stride] = rgb[2] / 255.f;
                         }
                     });
    }
    else if (tf != TransferFunction_Linear)
    {
        float *rgb[] = {r, g, b};
        for (int c = 0; c < num_channels; ++c)
            // other transfer functions apply to each channel independently
            parallel_for(blocked_range<int>(0, num_pixels, 1024 * 1024 / num_channels),
                         [rgb, c, tf, gamma, stride](int start, int end, int, int)
                         {
                             for (int i = start; i < end; ++i)
                                 rgb[c][i * stride] = to_linear(rgb[c][i * stride], tf, gamma);
                         });
    }
}

void from_linear(float *pixels, int3 size, TransferFunction tf, float gamma)
{
    if (tf == TransferFunction_BT2100_HLG && (size.z == 3 || size.z == 4))
    {
        // HLG needs to operate on all three channels at once
        if (size.z == 3)
            parallel_for(blocked_range<int>(0, size.x * size.y, 1024 * 1024),
                         [rgb = reinterpret_cast<float3 *>(pixels)](int start, int end, int, int)
                         {
                             for (int i = start; i < end; ++i) rgb[i] = inverse_EOTF_BT2100_HLG(rgb[i] * 255.f);
                         });
        else // size.z == 4
            // don't modify the alpha channel
            parallel_for(blocked_range<int>(0, size.x * size.y, 1024 * 1024),
                         [rgba = reinterpret_cast<float4 *>(pixels)](int start, int end, int, int)
                         {
                             for (int i = start; i < end; ++i)
                                 rgba[i].xyz() = inverse_EOTF_BT2100_HLG(rgba[i].xyz() * 255.f);
                         });
    }
    else
    {
        // assume this means we have an alpha channel, which we pass through without modification
        int num_color_channels = (size.z == 2 || size.z == 4) ? size.z - 1 : size.z;
        // other transfer functions apply to each channel independently
        parallel_for(blocked_range<int>(0, size.x * size.y, 1024 * 1024 / size.z),
                     [&pixels, tf, gamma, size, num_color_channels](int start, int end, int, int)
                     {
                         for (int i = start; i < end; ++i)
                             for (int c = 0; c < num_color_channels; ++c)
                                 pixels[i * size.z + c] = from_linear(pixels[i * size.z + c], tf, gamma);
                     });
    }
}
